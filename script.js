import{initializeApp as e}from"https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";import{getAuth as t,GoogleAuthProvider as o,signInWithPopup as s,signOut as n,onAuthStateChanged as r}from"https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";import{getFirestore as a,doc as i,collection as d,setDoc as l,getDoc as c,onSnapshot as p,serverTimestamp as g,query as u,orderBy as m,limit as f,updateDoc as y}from"https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";let firebaseConfig={apiKey:"AIzaSyCVCVQH42XxhHQAK1Lj4wWpZLZFVMfy33w",authDomain:"pop-koung.firebaseapp.com",projectId:"pop-koung",storageBucket:"pop-koung.appspot.com",messagingSenderId:"717319598468",appId:"1:717319598468:web:cda33788dd6e4252486dd1",measurementId:"G-H2K0C1QD7W"},app=e(firebaseConfig),auth=t(app),db=a(app),cat=document.getElementById("cat"),sound=document.getElementById("popSound"),scoreElement=document.getElementById("score"),foodElement=document.getElementById("food"),loginBtn=document.getElementById("loginBtn"),logoutBtn=document.getElementById("logoutBtn"),leaderboardList=document.getElementById("leaderboardList"),score=0,isSoundPlaying=!1,user=null;loginBtn.addEventListener("click",()=>{let e=new o;s(auth,e).then(async e=>{user=e.user,console.log("User logged in:",user),loginBtn.style.display="none",logoutBtn.style.display="inline";let t=localStorage.getItem("guestScore")||0;await mergeVisitorScore(user.uid,user.displayName,parseInt(t,10)),localStorage.removeItem("guestScore"),scoreElement.textContent="0",await updateScoreDisplay(user.uid)}).catch(e=>{console.error("Login error:",e)})}),logoutBtn.addEventListener("click",()=>{n(auth).then(()=>{console.log("User logged out"),loginBtn.style.display="inline",logoutBtn.style.display="none",scoreElement.textContent=localStorage.getItem("guestScore")||"0",user=null,score=0,loadLeaderboard()}).catch(e=>{console.error("Logout error:",e)})});let foodImages=["food1.png","food2.png","food3.png","food4.png"],foodIndex=0;function popCat(){isSoundPlaying||(isSoundPlaying=!0,cat.src="open2.png",sound.play(),scoreElement.classList.add("bounce"),foodElement.classList.add("up"),setTimeout(()=>{cat.src="closed2.png"},300),sound.onended=function(){if(score++,setTimeout(()=>{scoreElement.textContent=score,scoreElement.classList.remove("bounce"),foodElement.classList.remove("up"),foodElement.src=foodImages[foodIndex],foodIndex=(foodIndex+1)%foodImages.length},200),user)updateFirestoreScore(user.uid,score);else{let e=localStorage.getItem("guestScore")||0;e=parseInt(e,10)+1,localStorage.setItem("guestScore",e),scoreElement.textContent=score}isSoundPlaying=!1})}async function mergeVisitorScore(e,t,o){let s=i(db,"scores",e);try{let n=await c(s);if(n.exists()){let r=n.data().score||0;score=r+o,await y(s,{score:r+o,timestamp:g()})}else score=o,await l(s,{uid:e,displayName:t,score:o,timestamp:g()});scoreElement.textContent=score}catch(a){console.error("Error merging visitor score:",a)}}async function updateScoreDisplay(e){let t=i(db,"scores",e);try{let o=await c(t);if(o.exists()){let s=o.data();score=s.score||0,scoreElement.textContent=score}else scoreElement.textContent="0"}catch(n){console.error("Error getting user score:",n),scoreElement.textContent="0"}}async function updateFirestoreScore(e,t){let o=i(db,"scores",e);try{await y(o,{score:t,timestamp:g()})}catch(s){console.error("Error updating Firestore score:",s)}}function loadLeaderboard(){let e=d(db,"scores"),t=u(e,m("score","desc"),f(10));p(t,e=>{if(leaderboardList.innerHTML="",e.forEach(e=>{let t=e.data(),o=document.createElement("li");o.innerHTML=`<i class="trophy fas fa-trophy"></i><span>${t.displayName}</span><span>${t.score}</span>`,leaderboardList.appendChild(o)}),!user){let t=localStorage.getItem("guestScore");if(t){let o=document.createElement("li");o.innerHTML=`<span>Visitor</span><span>${t}</span>`,leaderboardList.appendChild(o)}}},e=>{console.error("Error loading leaderboard:",e)})}document.addEventListener("DOMContentLoaded",()=>{loadLeaderboard(),r(auth,async e=>{e?(user=e,loginBtn.style.display="none",logoutBtn.style.display="inline",await updateScoreDisplay(user.uid)):(loginBtn.style.display="inline",logoutBtn.style.display="none",scoreElement.textContent=localStorage.getItem("guestScore")||"0")}),cat&&cat.addEventListener("click",popCat);let e=document.getElementById("score-container");e&&e.addEventListener("click",popCat),scoreElement&&scoreElement.addEventListener("click",popCat),foodElement&&foodElement.addEventListener("click",popCat)});